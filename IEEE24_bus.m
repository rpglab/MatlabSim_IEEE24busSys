clear 
clc
%load optimgains.mat
%DC source and governor-turbine time constants
ps = 1;
tau_dc=0.05;tau_g=5;
%defining SM governer gain----------------------
droop_percentage=1;
%% Network base values
S_b=100*(10^6);
V_b=230*(10^3);%L-L rms voltage
V_bl=138*(10^3);
f_b=60;w_b=2*pi*f_b;
P_b=S_b;Q_b=S_b;
I_b=S_b/(sqrt(3)*V_b);
Z_b=(V_b^2)/S_b;L_b=Z_b/w_b;C_b=1/(w_b*Z_b);
V2_rms=230e3; %Medium voltage side
%% Load Settings
Pen = 1;
L_cnt = 1.0215;
Ts= 1e-4;
L1 = 108e6*L_cnt;
L2 = 97e6*L_cnt;
L3 = 90e6*L_cnt;
L4 = 154e6*L_cnt;
L5 = 171e6*L_cnt;
L6 = 148e6*L_cnt;
L7 = 62e6*L_cnt;
L8 = 85e6*L_cnt;
L9 = 175e6*L_cnt;
L10 = 100e6*L_cnt;
L13 = 130e6*L_cnt;
L14 = 192e6*L_cnt;
L15 = 158e6*L_cnt;
L16 = 100e6*L_cnt;
L18 = 162e6*L_cnt;
L19 = 190e6*L_cnt;
L20 = 165e6*L_cnt;
L21 = 100e6*L_cnt;

%%Generator Models
PSSMODEL=1;
%bus p(MW)  q (MVar)

%bus  MW(each unit)	KV	H	Xa	Xd	Xq	Xd'	Tdo' Xd"	Tdo"	Xq'	Tqo'	Xq"	Tqo"	r
%1	   2	        3	4	5	6	7	8	9	 10	     11	    12	13	    14	15	   16
G_data=[...
011	15.8 138	2.8	0.2     2.7	1.5     0.3     7.5     0.25	0.04	0.85	0.85	0.25	0.12	0
012	15.8 138	3.2	0.2     1.8	1.75	0.3     8.5     0.21	0.04	0.7     2       0.21	0.25	0
013	181.5 138	3.2	0.2     1.8	1.75	0.3     8.5     0.21	0.04	0.7     2       0.21	0.25	0
021	19.5	138	2.8	0.2     2.7	1.5     0.3     7.5     0.25	0.04	0.85	0.85	0.25	0.12	0
022	19.5	138	3.2	0.2     1.8	1.75	0.3     8.5     0.21	0.04	0.7     2       0.21	0.25	0
023	76	138	2.8	0.2     2.7	1.5     0.3     7.5     0.25	0.04	0.85	0.85	0.25	0.12	0
024	76	138	3.2	0.2     1.8	1.75	0.3     8.5     0.21	0.04	0.7     2       0.21	0.25	0
025	76	138	3.2	0.2     1.8	1.75	0.3     8.5     0.21	0.04	0.7     2       0.21	0.25	0
026	76	138	3.2	0.2     1.8	1.75	0.3     8.5     0.21	0.04	0.7     2       0.21	0.25	0
071	59.2 138	2.8	0.17	2.2	2.1     0.3     4.5     0.2     0.04	0.5     1.5     0.21	0.06	0
131	164.24	230	2.8	0.2     2.7	1.5     0.3     7.5     0.25	0.04	0.85	0.85	0.25	0.12	0
132	76	230	2.8	0.2     2.7	1.5     0.3     7.5     0.25	0.04	0.85	0.85	0.25	0.12	0
133	76	230	2.6	0.2     2.3	1.7     0.3     5       0.25	0.03	0.4     2       0.25	0.25	0
134	76	230	2.6	0.2     2.3	1.7     0.3     5       0.25	0.03	0.4     2       0.25	0.25	0
135	362.98	230	2.6	0.2     2.3	1.7     0.3     5       0.25	0.03	0.4     2       0.25	0.25	0                  
151	2.4	230	3.2	0.2     1.8	1.75	0.3     8.5     0.21	0.04	0.7     2       0.21	0.25	0
152	155	230	2.8	0.2     2.7	1.5     0.3     7.5     0.25	0.04	0.85	0.85	0.25	0.12	0
153	155	230	3.2	0.2     1.8	1.75	0.3     8.5     0.21	0.04	0.7     2       0.21	0.25	0
154	240.69	230	2.6	0.2     2.3	1.7     0.3     5       0.25	0.03	0.4     2       0.25	0.25	0
161	54.25	230	2.8	0.2     2.7	1.5     0.3     7.5     0.25	0.04	0.85	0.85	0.25	0.12	0
181	187.55	230	2.6	0.2     2.3	1.7     0.3     5       0.25	0.03	0.4     2       0.25	0.25	0
182	59.2	233	3.2	0.2     1.8	1.75	0.3     8.5     0.21	0.04	0.7     2       0.21	0.25	0
211	54.12	230	3.2	0.2     1.8	1.75	0.3     8.5     0.21	0.04	0.7     2       0.21	0.25	0
212	54.12	230	3.2	0.2     1.8	1.75	0.3     8.5     0.21	0.04	0.7     2       0.21	0.25	0
213	54.12	230	2.6	0.2     2.3	1.7     0.3     5       0.25	0.03	0.4     2       0.25	0.25	0
214	54.12	230	2.6	0.2     2.3	1.7     0.3     5       0.25	0.03	0.4     2       0.25	0.25	0
215	59.22	230	2.6	0.2     2.3	1.7     0.3     5       0.25	0.03	0.4     2       0.25	0.25	0
216	76	230	2.6	0.2     2.3	1.7     0.3     5       0.25	0.03	0.4     2       0.25	0.25	0
221	187.55 230	2.6	0.2     2.3	1.7     0.3     5       0.25	0.03	0.4     2       0.25	0.25	0
231	76 230	2.6	0.2     2.3	1.7     0.3     5       0.25	0.03	0.4     2       0.25	0.25	0
232	76 230	2.6	0.2     2.3	1.7     0.3     5       0.25	0.03	0.4     2       0.25	0.25	0
233	76 230	2.6	0.2     2.3	1.7     0.3     5       0.25	0.03	0.4     2       0.25	0.25	0
234	155 230	2.2	0.2     2.3	1.7     0.3     5       0.25	0.03	0.4     2       0.25	0.25	0
235	155 230	2.2	0.2     2.3	1.7     0.3     5       0.25	0.03	0.4     2       0.25	0.25	0
236	181.49 230	2.6	0.2     2.3	1.7     0.3     5       0.25	0.03	0.4     2       0.25	0.25	0];


%% H Constant Modification
H011 = 4;
H012 = 4;
H013 = 4;
H021 = 4;
H022 = 4;
H023 = 4;
H024 = 4;
H025 = 4;
H026 = 4;
H071 = 4;
H131 = 4;
H132 = 4;
H133 = 4;
H134 = 4;
H135 = 4;
H151 = 4;
H152 = 4;
H153 = 4;
H154 = 4;
H161 = 4;
H181 = 3.25;
H182 = 4;
H211 = 4;
H212 = 4;
H213 = 4;
H214 = 4;
H215 = 4;
H216 = 4;
H221 = 3.25;
H231 = 4;
H232 = 4;
H233 = 4;
H234 = 4;
H235 = 4;
H236 = 4;

%% Wind Farm Parameters
KP1 = 1;
KP2 = 1;
KP3 = 1;
KP4 = 1;
KP5 = 1;
KI1 = 1;
KI2 = 1;
KI3 = 1;
KI4 = 1;
KI5 = 1;


gentestcase=[2:8,11,12,14];
genrem=setdiff(1:14,gentestcase);
Hinv=1/2*diag(G_data(gentestcase,4))^-1;


% 1	  2   3     4   	5       6	7   8	    9	    10	   11	    12
% bus Tr KA	   TA   	TB      TC	KE	TE      KF      TF     TB1(s)	TC1(s)
Exc=[...
011	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
012	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
013	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
%201	0	 300	0.01	0.7	   0.35	 0	0       0       0       0       0
021	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
022	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
023	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
024	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
025	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
026	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
071	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
131	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
132	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
133	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
134	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
135	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
%204	0	 300	0.01	0.7	   0.35	 0	0       0       0       0       0
151	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
152	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
153	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
154	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
161	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
181	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
182	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
211	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
212	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
213	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
214	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
215	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
216	0	 200	0.02	1.12   0.5   0	0       0       0       0       0
221	0 200	0.02	1.12   0.5   0	0       0       0       0       0
231 0	 200	0.02	1.12   0.5   0	0       0       0       0       0
232 0	 200	0.02	1.12   0.5   0	0       0       0       0       0
233 0	 200	0.02	1.12   0.5   0	0       0       0       0       0
234 0	 200	0.02	1.12   0.5   0	0       0       0       0       0
235 0	 200	0.02	1.12   0.5   0	0       0       0       0       0
236 0	 200	0.02	1.12   0.5   0	0       0       0       0       0
];
 Exc(:,2)=0.02;
 Exc(13,9)=.001;
 Exc(13,10)=1;
% bus rating pg (MW) Heavy load case


% bus	MVA(per unit)	p(per unit)	q(per unit)	active units

% No bus QL  Qc
 G=1; FL=.1; KL=10; FI=1; KI=10; FH=13; KH=120;
 Tr=.001;
 Ka=200; Ta=.001;
 Ke=1;   Te=0;
 Tb=0;  Tc=0;
 Kf=0;   Tf=0;
 Efmin=-5; Efmax=5;

alpha(1:15)=0*1e11*ones(15,1);
alpha(16:30)=0*1e8*ones(15,1);
nred=90;

%PLL parameters
PLL_Ki=2/500;
PLL_Kp=2/500;
PLL_tau=1/500;


visat=inf;%(40+2.9)*1e6;
Isel=eye(2*15);
Isel_forming=eye(3*15);


Kvsc(1,:)=1*ones(1,15);
Kvsc(2,:)=1*ones(1,15);

dist.inp=zeros(6,1);
dist.sc=ones(6,1);
dist.time=50;



c_fil=1e-5; % 1e-5
r_fil=5e-1;
l_fil=5e-3;


% Grid forming
Pinit=zeros(15,1);

%sim('IEEE24bus',100)
%{
[t_time,x_state,y_out]=sim('out1',[0,30]);
filename_time='G:\GridFormingConverters-master\GridFormingConverters-master\data.xls';
sheet='sheet1';
position='A1';
xlswrite(filename_time,t_time,sheet,position);
%}